"use strict";var t=require("../../events/event-info.cjs"),e=require("../../frameloop/index.cjs"),n=require("../../utils/time-conversion.cjs"),s=require("../../events/add-pointer-event.cjs"),i=require("../../utils/pipe.cjs"),o=require("../../utils/distance.cjs"),r=require("../../frameloop/data.cjs"),a=require("../../events/utils/is-primary-pointer.cjs");function h(t,e){return e?{point:e(t.point)}:t}function l(t,e){return{x:t.x-e.x,y:t.y-e.y}}function v({point:t},e){return{point:t,delta:l(t,c(e)),offset:l(t,u(e)),velocity:d(e,.1)}}function u(t){return t[0]}function c(t){return t[t.length-1]}function d(t,e){if(t.length<2)return{x:0,y:0};let s=t.length-1,i=null;const o=c(t);for(;s>=0&&(i=t[s],!(o.timestamp-i.timestamp>n.secondsToMilliseconds(e)));)s--;if(!i)return{x:0,y:0};const r=n.millisecondsToSeconds(o.timestamp-i.timestamp);if(0===r)return{x:0,y:0};const a={x:(o.x-i.x)/r,y:(o.y-i.y)/r};return a.x===1/0&&(a.x=0),a.y===1/0&&(a.y=0),a}exports.PanSession=class{constructor(n,l,{transformPagePoint:u}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.updatePoint=()=>{if(!this.lastMoveEvent||!this.lastMoveEventInfo)return;const t=v(this.lastMoveEventInfo,this.history),e=null!==this.startEvent,n=o.distance2D(t.offset,{x:0,y:0})>=3;if(!e&&!n)return;const{point:s}=t,{timestamp:i}=r.frameData;this.history.push({...s,timestamp:i});const{onStart:a,onMove:h}=this.handlers;e||(a&&a(this.lastMoveEvent,t),this.startEvent=this.lastMoveEvent),h&&h(this.lastMoveEvent,t)},this.handlePointerMove=(t,n)=>{this.lastMoveEvent=t,this.lastMoveEventInfo=h(n,this.transformPagePoint),e.frame.update(this.updatePoint,!0)},this.handlePointerUp=(t,e)=>{if(this.end(),!this.lastMoveEvent||!this.lastMoveEventInfo)return;const{onEnd:n,onSessionEnd:s}=this.handlers,i=v("pointercancel"===t.type?this.lastMoveEventInfo:h(e,this.transformPagePoint),this.history);this.startEvent&&n&&n(t,i),s&&s(t,i)},!a.isPrimaryPointer(n))return;this.handlers=l,this.transformPagePoint=u;const c=h(t.extractEventInfo(n),this.transformPagePoint),{point:d}=c,{timestamp:p}=r.frameData;this.history=[{...d,timestamp:p}];const{onSessionStart:f}=l;f&&f(n,v(c,this.history)),this.removeListeners=i.pipe(s.addPointerEvent(window,"pointermove",this.handlePointerMove),s.addPointerEvent(window,"pointerup",this.handlePointerUp),s.addPointerEvent(window,"pointercancel",this.handlePointerUp))}updateHandlers(t){this.handlers=t}end(){this.removeListeners&&this.removeListeners(),e.cancelFrame(this.updatePoint)}};
