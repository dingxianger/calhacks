import{extractEventInfo as t}from"../../events/event-info.js";import{frame as n,cancelFrame as e}from"../../frameloop/index.js";import{secondsToMilliseconds as s,millisecondsToSeconds as i}from"../../utils/time-conversion.js";import{addPointerEvent as o}from"../../events/add-pointer-event.js";import{pipe as r}from"../../utils/pipe.js";import{distance2D as a}from"../../utils/distance.js";import{frameData as h}from"../../frameloop/data.js";import{isPrimaryPointer as l}from"../../events/utils/is-primary-pointer.js";class m{constructor(e,s,{transformPagePoint:i}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.updatePoint=()=>{if(!this.lastMoveEvent||!this.lastMoveEventInfo)return;const t=f(this.lastMoveEventInfo,this.history),n=null!==this.startEvent,e=a(t.offset,{x:0,y:0})>=3;if(!n&&!e)return;const{point:s}=t,{timestamp:i}=h;this.history.push({...s,timestamp:i});const{onStart:o,onMove:r}=this.handlers;n||(o&&o(this.lastMoveEvent,t),this.startEvent=this.lastMoveEvent),r&&r(this.lastMoveEvent,t)},this.handlePointerMove=(t,e)=>{this.lastMoveEvent=t,this.lastMoveEventInfo=p(e,this.transformPagePoint),n.update(this.updatePoint,!0)},this.handlePointerUp=(t,n)=>{if(this.end(),!this.lastMoveEvent||!this.lastMoveEventInfo)return;const{onEnd:e,onSessionEnd:s}=this.handlers,i=f("pointercancel"===t.type?this.lastMoveEventInfo:p(n,this.transformPagePoint),this.history);this.startEvent&&e&&e(t,i),s&&s(t,i)},!l(e))return;this.handlers=s,this.transformPagePoint=i;const m=p(t(e),this.transformPagePoint),{point:v}=m,{timestamp:u}=h;this.history=[{...v,timestamp:u}];const{onSessionStart:d}=s;d&&d(e,f(m,this.history)),this.removeListeners=r(o(window,"pointermove",this.handlePointerMove),o(window,"pointerup",this.handlePointerUp),o(window,"pointercancel",this.handlePointerUp))}updateHandlers(t){this.handlers=t}end(){this.removeListeners&&this.removeListeners(),e(this.updatePoint)}}function p(t,n){return n?{point:n(t.point)}:t}function v(t,n){return{x:t.x-n.x,y:t.y-n.y}}function f({point:t},n){return{point:t,delta:v(t,d(n)),offset:v(t,u(n)),velocity:c(n,.1)}}function u(t){return t[0]}function d(t){return t[t.length-1]}function c(t,n){if(t.length<2)return{x:0,y:0};let e=t.length-1,o=null;const r=d(t);for(;e>=0&&(o=t[e],!(r.timestamp-o.timestamp>s(n)));)e--;if(!o)return{x:0,y:0};const a=i(r.timestamp-o.timestamp);if(0===a)return{x:0,y:0};const h={x:(r.x-o.x)/a,y:(r.y-o.y)/a};return h.x===1/0&&(h.x=0),h.y===1/0&&(h.y=0),h}export{m as PanSession};
