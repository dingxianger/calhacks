import*as e from"react";import{useContext as t,useRef as r,cloneElement as n,Children as o,isValidElement as s}from"react";import{useForceUpdate as i}from"../../utils/use-force-update.js";import{useIsMounted as c}from"../../utils/use-is-mounted.js";import{PresenceChild as u}from"./PresenceChild.js";import{LayoutGroupContext as m}from"../../context/LayoutGroupContext.js";import{useIsomorphicLayoutEffect as a}from"../../utils/use-isomorphic-effect.js";import{useUnmountEffect as f}from"../../utils/use-unmount-effect.js";import{invariant as l}from"../../utils/errors.js";const p=e=>e.key||"";const d=({children:d,custom:h,initial:E=!0,onExitComplete:y,exitBeforeEnter:x,presenceAffectsLayout:w=!0,mode:j="sync"})=>{l(!x,"Replace exitBeforeEnter with mode='wait'");const g=t(m).forceRender||i()[0],k=c(),v=function(e){const t=[];return o.forEach(e,(e=>{s(e)&&t.push(e)})),t}(d);let A=v;const L=r(new Map).current,P=r(A),C=r(new Map).current,O=r(!0);if(a((()=>{O.current=!1,function(e,t){e.forEach((e=>{const r=p(e);t.set(r,e)}))}(v,C),P.current=A})),f((()=>{O.current=!0,C.clear(),L.clear()})),O.current)return e.createElement(e.Fragment,null,A.map((t=>e.createElement(u,{key:p(t),isPresent:!0,initial:!!E&&void 0,presenceAffectsLayout:w,mode:j},t))));A=[...A];const z=P.current.map(p),b=v.map(p),B=z.length;for(let e=0;e<B;e++){const t=z[e];-1!==b.indexOf(t)||L.has(t)||L.set(t,void 0)}return"wait"===j&&L.size&&(A=[]),L.forEach(((t,r)=>{if(-1!==b.indexOf(r))return;const n=C.get(r);if(!n)return;const o=z.indexOf(r);let s=t;if(!s){const t=()=>{C.delete(r),L.delete(r);const e=P.current.findIndex((e=>e.key===r));if(P.current.splice(e,1),!L.size){if(P.current=v,!1===k.current)return;g(),y&&y()}};s=e.createElement(u,{key:p(n),isPresent:!1,onExitComplete:t,custom:h,presenceAffectsLayout:w,mode:j},n),L.set(r,s)}A.splice(o,0,s)})),A=A.map((t=>{const r=t.key;return L.has(r)?t:e.createElement(u,{key:p(t),isPresent:!0,presenceAffectsLayout:w,mode:j},t)})),"production"!==process.env.NODE_ENV&&"wait"===j&&A.length>1&&console.warn('You\'re attempting to animate multiple children within AnimatePresence, but its mode is set to "wait". This will lead to odd visual behaviour.'),e.createElement(e.Fragment,null,L.size?A:A.map((e=>n(e))))};export{d as AnimatePresence};
