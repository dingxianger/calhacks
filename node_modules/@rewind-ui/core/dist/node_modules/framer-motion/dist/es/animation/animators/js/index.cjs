"use strict";var e=require("../../generators/keyframes.cjs"),t=require("../../generators/spring/index.cjs"),n=require("../../generators/inertia.cjs"),r=require("./driver-frameloop.cjs"),l=require("../../../utils/interpolate.cjs"),a=require("../../../utils/clamp.cjs"),i=require("../../../utils/time-conversion.cjs"),s=require("../../generators/utils/calc-duration.cjs");const o={decay:n.inertia,inertia:n.inertia,tween:e.keyframes,keyframes:e.keyframes,spring:t.spring};exports.animateValue=function({autoplay:t=!0,delay:n=0,driver:u=r.frameloopDriver,keyframes:c,type:d="keyframes",repeat:m=0,repeatDelay:p=0,repeatType:f="loop",onPlay:y,onStop:v,onComplete:g,onUpdate:h,...k}){let D,j,q=1,M=!1;const T=()=>{D&&D(),j=new Promise((e=>{D=e}))};let w;T();const x=o[d]||e.keyframes;let S;x!==e.keyframes&&"number"!=typeof c[0]&&(S=l.interpolate([0,100],c,{clamp:!1}),c=[0,100]);const G=x({...k,keyframes:c});let P;"mirror"===f&&(P=x({...k,keyframes:[...c].reverse(),velocity:-(k.velocity||0)}));let b="idle",B=null,C=null,U=null;null===G.calculatedDuration&&m&&(G.calculatedDuration=s.calcGeneratorDuration(G));const{calculatedDuration:V}=G;let z=1/0,A=1/0;null!==V&&(z=V+p,A=z*(m+1)-p);let E=0;const F=e=>{if(null===C)return;q>0&&(C=Math.min(C,e)),q<0&&(C=Math.min(e-A/q,C)),E=null!==B?B:Math.round(e-C)*q;const t=E-n*(q>=0?1:-1),r=q>=0?t<0:t>A;E=Math.max(t,0),"finished"===b&&null===B&&(E=A);let l=E,i=G;if(m){const e=E/z;let t=Math.floor(e),n=e%1;!n&&e>=1&&(n=1),1===n&&t--,t=Math.min(t,m+1);const r=Boolean(t%2);r&&("reverse"===f?(n=1-n,p&&(n-=p/z)):"mirror"===f&&(i=P));let s=a.clamp(0,1,n);E>A&&(s="reverse"===f&&r?1:0),l=s*z}const s=r?{done:!1,value:c[0]}:i.next(l);S&&(s.value=S(s.value));let{done:o}=s;r||null===V||(o=q>=0?E>=A:E<=0);const u=null===B&&("finished"===b||"running"===b&&o);return h&&h(s.value),u&&J(),s},H=()=>{w&&w.stop(),w=void 0},I=()=>{b="idle",H(),T(),C=U=null},J=()=>{b="finished",g&&g(),H(),T()},K=()=>{if(M)return;w||(w=u(F));const e=w.now();y&&y(),null!==B?C=e-B:C&&"finished"!==b||(C=e),U=C,B=null,b="running",w.start()};t&&K();const L={then:(e,t)=>j.then(e,t),get time(){return i.millisecondsToSeconds(E)},set time(e){e=i.secondsToMilliseconds(e),E=e,null===B&&w&&0!==q?C=w.now()-e/q:B=e},get duration(){const e=null===G.calculatedDuration?s.calcGeneratorDuration(G):G.calculatedDuration;return i.millisecondsToSeconds(e)},get speed(){return q},set speed(e){e!==q&&w&&(q=e,L.time=i.millisecondsToSeconds(E))},get state(){return b},play:K,pause:()=>{b="paused",B=E},stop:()=>{M=!0,"idle"!==b&&(b="idle",v&&v(),I())},cancel:()=>{null!==U&&F(U),I()},complete:()=>{b="finished"},sample:e=>(C=0,F(e))};return L};
